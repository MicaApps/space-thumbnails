import sys
import os
import argparse
import time

# OCP imports
try:
    from OCP.STEPControl import STEPControl_Reader
    from OCP.IGESControl import IGESControl_Reader
    from OCP.IFSelect import IFSelect_RetDone
    from OCP.BRepMesh import BRepMesh_IncrementalMesh
    from OCP.TopExp import TopExp_Explorer
    from OCP.TopAbs import TopAbs_FACE
    from OCP.TopoDS import TopoDS
    from OCP.BRep import BRep_Tool
    from OCP.TopLoc import TopLoc_Location
except ImportError:
    print("[Python-OCC] Error: OCP module not found. Please install cadquery-ocp.", flush=True)
    sys.exit(1)

def log_debug(msg):
    print(f"[Python-OCC] {msg}", flush=True)

def convert_step_to_obj(input_path, output_path, deflection=0.5):
    start_time = time.time()
    
    ext = os.path.splitext(input_path)[1].lower()
    
    # 1. Read File
    if ext in ['.stp', '.step']:
        log_debug(f"Reading STEP: {input_path}")
        reader = STEPControl_Reader()
        status = reader.ReadFile(input_path)
    elif ext in ['.igs', '.iges']:
        log_debug(f"Reading IGES: {input_path}")
        reader = IGESControl_Reader()
        status = reader.ReadFile(input_path)
    else:
        log_debug(f"Unsupported extension: {ext}")
        return False
    
    if status != IFSelect_RetDone:
        log_debug("Error: Cannot read input file.")
        return False
        
    reader.TransferRoots()
    shape = reader.OneShape()
    
    if shape.IsNull():
        log_debug("Error: Resulting shape is null.")
        return False

    # 2. Mesh (Tessellate)
    # LinearDeflection controls the quality. 
    # Try 0.5 (assuming mm). 
    log_debug(f"Meshing with deflection {deflection}...")
    try:
        BRepMesh_IncrementalMesh(shape, deflection) 
    except Exception as e:
        log_debug(f"Meshing failed: {e}")
        return False
    
    # 3. Extract Triangulation and Write OBJ
    log_debug("Extracting mesh data...")
    
    total_vertices = 0
    total_faces = 0
    triangulated_faces = 0
    
    with open(output_path, 'w') as f:
        f.write(f"# Generated by space-thumbnails (OCP)\n")
        
        exp = TopExp_Explorer(shape, TopAbs_FACE)
        vertex_offset = 1
        
        while exp.More():
            face = TopoDS.Face(exp.Current())
            location = TopLoc_Location()
            triangulation = BRep_Tool.Triangulation_s(face, location)
            
            if triangulation:
                triangulated_faces += 1
                
                trsf = location.Transformation()
                
                node_count = triangulation.NbNodes()
                tri_count = triangulation.NbTriangles()
                
                # Write Vertices
                for i in range(1, node_count + 1):
                    p = triangulation.Node(i)
                    p.Transform(trsf)
                    f.write(f"v {p.X()} {p.Y()} {p.Z()}\n")
                    
                # Write Faces
                for i in range(1, tri_count + 1):
                    tri = triangulation.Triangle(i)
                    n1, n2, n3 = tri.Get()
                    f.write(f"f {n1 + vertex_offset - 1} {n2 + vertex_offset - 1} {n3 + vertex_offset - 1}\n")
                
                vertex_offset += node_count
                total_vertices += node_count
                total_faces += tri_count
            
            exp.Next()
            
    log_debug(f"Exported OBJ: {total_vertices} vertices, {total_faces} faces from {triangulated_faces} triangulated faces.")
    log_debug(f"Time elapsed: {time.time() - start_time:.4f}s")
    
    if total_vertices == 0:
        log_debug("Warning: No vertices exported!")
        return False
        
    return True

if __name__ == "__main__":
    input_file = os.environ.get("STEP2OBJ_INPUT")
    output_file = os.environ.get("STEP2OBJ_OUTPUT")
    
    if not input_file and len(sys.argv) > 1:
        input_file = sys.argv[1]
    if not output_file and len(sys.argv) > 2:
        output_file = sys.argv[2]
        
    if not input_file or not output_file:
        log_debug("Usage: Set STEP2OBJ_INPUT and STEP2OBJ_OUTPUT env vars")
        sys.exit(1)
        
    try:
        # Use coarser deflection for thumbnails (2.0 for faster processing and smaller mesh)
        success = convert_step_to_obj(input_file, output_file, deflection=2.0)
        sys.exit(0 if success else 1)
    except Exception as e:
        log_debug(f"Exception: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)